library ieee; 
use ieee.std_logic_1164.all; 
use ieee.numeric_std.all;

entity kb_test is
	port(rstn, clk, PS2_CLKA, PS2_DATA : in std_logic;
		  Key_Code : out std_logic_vector(4 downto 0);
		  C_enable : out std_logic;
		  Cs_enable : out std_logic;
		  D_enable : out std_logic;
		  Ds_enable : out std_logic;
		  E_enable : out std_logic;
		  F_enable : out std_logic;
		  Fs_enable : out std_logic;
		  G_enable : out std_logic;
		  Gs_enable : out std_logic;
		  A_enable : out std_logic;
		  As_enable : out std_logic;
		  B_enable : out std_logic;
		  C2_enable : out std_logic;
		  Setting_ID : out std_logic_vector(2 downto 0);
		  output_LED : out std_logic;
		  test_LED : out std_logic);
end entity;

architecture arch of kb_test is
signal shiftreg : std_logic_vector(9 downto 0);
signal shiftreg_old : std_logic_vector(9 downto 0);
signal PS2_CLK2, PS2_CLK2_old, PS2_DAT2, detected_fall: std_logic;
signal Internal_Key_Code : std_logic_vector(4 downto 0);
signal shiftreg_counter : unsigned(3 downto 0);
signal C_make_enabler : std_logic;
signal Cs_make_enabler : std_logic;
signal D_make_enabler : std_logic;
signal Ds_make_enabler : std_logic;
signal E_make_enabler : std_logic;
signal F_make_enabler : std_logic;
signal Fs_make_enabler : std_logic;
signal G_make_enabler : std_logic;
signal Gs_make_enabler : std_logic;
signal A_make_enabler : std_logic;
signal As_make_enabler : std_logic;
signal B_make_enabler : std_logic;
signal C2_make_enabler : std_logic;
signal C_enable_internal : std_logic;
signal Cs_enable_internal : std_logic;
signal D_enable_internal : std_logic;
signal Ds_enable_internal : std_logic;
signal E_enable_internal : std_logic;
signal F_enable_internal : std_logic;
signal Fs_enable_internal : std_logic;
signal G_enable_internal : std_logic;
signal Gs_enable_internal : std_logic;
signal A_enable_internal : std_logic;
signal As_enable_internal : std_logic;
signal B_enable_internal : std_logic;
signal C2_enable_internal : std_logic;
signal Setting_ID_buf : std_logic_vector(2 downto 0);
signal output_LED_internal : std_logic;
signal test_LED_i : std_logic;

begin
	
	p1 : process (clk) begin 
		 if rising_edge(clk) then
			PS2_DAT2 <= PS2_DATA; 
			PS2_CLK2 <= PS2_CLKA; 
			PS2_CLK2_old <= PS2_CLK2;
		 end if; 
	end process; 
		
		detected_fall <= (NOT PS2_CLK2 AND PS2_CLK2_old); 
	
	p2 : process(clk,rstn) begin 
		
		if rstn = '0' then 
			shiftreg <= "0000000000";
			shiftreg_counter <= "0000";
		elsif rising_edge(clk) then
			if detected_fall = '1' then
				shiftreg(9) <= PS2_DAT2;
				shiftreg(8 downto 0) <= shiftreg(9 downto 1);
				shiftreg_counter <= shiftreg_counter + 1;
			end if;
			if (shiftreg_counter = "1011") then
				shiftreg_old <= shiftreg;
				shiftreg_counter <= "0000";

				---------- Check for C ----------
				if (shiftreg(7 downto 0) = "00011100" AND shiftreg_old(7 downto 0) = "11110000") then
					C_make_enabler <= '0';
				elsif (shiftreg(7 downto 0) = "00011100" AND C_make_enabler = '0') then
					C_make_enabler <= '1';
					output_LED_internal <= '1';
				---------------------------------
				
				---------- Check for Cs ----------
				elsif (shiftreg(7 downto 0) = "00011101" AND shiftreg_old(7 downto 0) = "11110000") then
					Cs_make_enabler <= '0';
				elsif (shiftreg(7 downto 0) = "00011101" AND Cs_make_enabler = '0') then
					Cs_make_enabler <= '1';
					--output_LED_internal <= '1';
					test_LED_i <= '1';
				---------------------------------
							
				---------- Check for D ----------
				elsif (shiftreg(7 downto 0) = "00011011" AND shiftreg_old(7 downto 0) = "11110000") then
					D_make_enabler <= '0';
				elsif (shiftreg(7 downto 0) = "00011011" AND D_make_enabler = '0') then
					D_make_enabler <= '1';
					output_LED_internal <= '1';
			
				---------------------------------
							
				---------- Check for Ds ----------
				elsif (shiftreg(7 downto 0) = "00100100" AND shiftreg_old(7 downto 0) = "11110000") then
					Ds_make_enabler <= '0';
				elsif (shiftreg(7 downto 0) = "00100100" AND Ds_make_enabler = '0') then
					Ds_make_enabler <= '1';
					output_LED_internal <= '1';

				---------------------------------
							
				---------- Check for E ----------
				elsif (shiftreg(7 downto 0) = "00100011" AND shiftreg_old(7 downto 0) = "11110000") then
					E_make_enabler <= '0';
				elsif (shiftreg(7 downto 0) = "00100011" AND E_make_enabler = '0') then
					E_make_enabler <= '1';
					output_LED_internal <= '1';

				---------------------------------
							
				---------- Check for F ----------
				elsif (shiftreg(7 downto 0) = "00101011" AND shiftreg_old(7 downto 0) = "11110000") then
					F_make_enabler <= '0';
				elsif (shiftreg(7 downto 0) = "00101011" AND F_make_enabler = '0') then
					F_make_enabler <= '1';
					output_LED_internal <= '1';

				---------------------------------
							
				---------- Check for Fs ----------
				elsif (shiftreg(7 downto 0) = "00101100" AND shiftreg_old(7 downto 0) = "11110000") then
					Fs_make_enabler <= '0';
				elsif (shiftreg(7 downto 0) = "00101100" AND Fs_make_enabler = '0') then
					Fs_make_enabler <= '1';
					output_LED_internal <= '1';

				---------------------------------
							
				---------- Check for G ----------
				elsif (shiftreg(7 downto 0) = "00110100" AND shiftreg_old(7 downto 0) = "11110000") then
					G_make_enabler <= '0';
				elsif (shiftreg(7 downto 0) = "00110100" AND G_make_enabler = '0') then
					G_make_enabler <= '1';
					output_LED_internal <= '1';

				---------------------------------
							
				---------- Check for Gs ----------
				elsif (shiftreg(7 downto 0) = "00110101" AND shiftreg_old(7 downto 0) = "11110000") then
					Gs_make_enabler <= '0';
				elsif (shiftreg(7 downto 0) = "00110101" AND Gs_make_enabler = '0') then
					Gs_make_enabler <= '1';
					output_LED_internal <= '1';

				---------------------------------
							
				---------- Check for A ----------
				elsif (shiftreg(7 downto 0) = "00110011" AND shiftreg_old(7 downto 0) = "11110000") then
					A_make_enabler <= '0';
				elsif (shiftreg(7 downto 0) = "00110011" AND A_make_enabler = '0') then
					A_make_enabler <= '1';
					output_LED_internal <= '1';

				---------------------------------
							
				---------- Check for As ----------
				elsif (shiftreg(7 downto 0) = "00111100" AND shiftreg_old(7 downto 0) = "11110000") then
					As_make_enabler <= '0';
				elsif (shiftreg(7 downto 0) = "00111100" AND As_make_enabler = '0') then
					As_make_enabler <= '1';
					output_LED_internal <= '1';

				---------------------------------
							
				---------- Check for B ----------
				elsif (shiftreg(7 downto 0) = "00111011" AND shiftreg_old(7 downto 0) = "11110000") then
					B_make_enabler <= '0';
				elsif (shiftreg(7 downto 0) = "00111011" AND B_make_enabler = '0') then
					B_make_enabler <= '1';
					output_LED_internal <= '1';

				---------------------------------
							
				---------- Check for C2 ----------
				elsif (shiftreg(7 downto 0) = "01000010" AND shiftreg_old(7 downto 0) = "11110000") then
					C2_make_enabler <= '0';
				elsif (shiftreg(7 downto 0) = "01000010" AND C2_make_enabler = '0') then
					C2_make_enabler <= '1';
					output_LED_internal <= '1';
				---------------------------------
				
				---------- Check for SETTING inputs ----------
				elsif (shiftreg(7 downto 0) = "00111010" AND shiftreg_old(7 downto 0) = "11110000") then
					Setting_ID_buf <= "001"; -- ID = Mute
				elsif (shiftreg(7 downto 0) = X"75" AND shiftreg_old(7 downto 0) = X"F0") then 
					Setting_ID_buf <= "010"; -- ID = Increase volume
				elsif (shiftreg(7 downto 0) = X"72" AND shiftreg_old(7 downto 0) = X"F0") then
					Setting_ID_buf <= "011"; -- ID = Decrease volume
				elsif (shiftreg(7 downto 0) = X"6B" AND shiftreg_old(7 downto 0) = X"F0") then
					Setting_ID_buf <= "100"; -- ID = Shift balance left
				elsif (shiftreg(7 downto 0) = X"74" AND shiftreg_old(7 downto 0) = X"F0") then
					Setting_ID_buf <= "101"; -- ID = Shift balance right
				
				else
					output_LED_internal <= '0';
					test_LED_i <= '0';
					--Setting_ID_buf <= "000";
				end if;
			
			end if;
		end if; 
	end process;
	
	C_enable <= C_enable_internal;
	Cs_enable <= Cs_enable_internal;
	D_enable <= D_enable_internal;
	Ds_enable <= Ds_enable_internal;
	E_enable <= E_enable_internal;
	F_enable <= F_enable_internal;
	Fs_enable <= Fs_enable_internal;
	G_enable <= G_enable_internal;
	Gs_enable <= Gs_enable_internal;
	A_enable <= A_enable_internal;
	As_enable <= As_enable_internal;
	B_enable <= B_enable_internal;
	C2_enable <= C2_enable_internal;
	Setting_ID <= Setting_ID_buf;
	output_LED <= output_LED_internal;
	test_LED <= test_LED_i;
	
	end architecture;
	
--	Key_Code <= "00001" when shiftreg(7 downto 0) = X"1C" and Break_found = '0' else -- C
--					"00010" when shiftreg(7 downto 0) = X"1D" and Break_found = '0' else -- C#
--					"00011" when shiftreg(7 downto 0) = X"1B" and Break_found = '0' else -- D
--					"00100" when shiftreg(7 downto 0) = X"24" and Break_found = '0' else -- D#
--					"00101" when shiftreg(7 downto 0) = X"23" and Break_found = '0' else -- E
--					"00110" when shiftreg(7 downto 0) = X"2B" and Break_found = '0' else -- F
--					"00111" when shiftreg(7 downto 0) = X"2C" and Break_found = '0' else -- F#
--					"01000" when shiftreg(7 downto 0) = X"34" and Break_found = '0' else -- G
--					"01001" when shiftreg(7 downto 0) = X"35" and Break_found = '0' else -- G#
--					"01010" when shiftreg(7 downto 0) = X"33" and Break_found = '0' else -- A
--					"01011" when shiftreg(7 downto 0) = X"3C" and Break_found = '0' else -- A#
--					"01100" when shiftreg(7 downto 0) = X"3B" and Break_found = '0' else -- B
--					"01101" when shiftreg(7 downto 0) = X"42" and Break_found = '0' else -- C2
--					    --"00000";
--	            "01110" when shiftreg(7 downto 0) = X"1C" and Break_found = '1' else -- C break
--					"01111" when shiftreg(7 downto 0) = X"1D" and Break_found = '1' else -- C# break
--					"10000" when shiftreg(7 downto 0) = X"1B" and Break_found = '1' else -- D break
--					"10001" when shiftreg(7 downto 0) = X"24" and Break_found = '1' else -- D# break
--					"10010" when shiftreg(7 downto 0) = X"23" and Break_found = '1' else -- E break
--					"10011" when shiftreg(7 downto 0) = X"2B" and Break_found = '1' else -- F break
--					"10100" when shiftreg(7 downto 0) = X"2C" and Break_found = '1' else -- F# break
--					"10101" when shiftreg(7 downto 0) = X"34" and Break_found = '1' else -- G break
--					"10110" when shiftreg(7 downto 0) = X"35" and Break_found = '1' else -- G# break
--					"10111" when shiftreg(7 downto 0) = X"33" and Break_found = '1' else -- A break
--					"11000" when shiftreg(7 downto 0) = X"3C" and Break_found = '1' else -- A# break
--					"11001" when shiftreg(7 downto 0) = X"3B" and Break_found = '1' else -- B break
--					"11010" when shiftreg(7 downto 0) = X"42" and Break_found = '1' else -- C2 break
--					    --"00000";
--	            "11011" when shiftreg(7 downto 0) = X"3A" else -- Mute
--				   "11100" when shiftreg(7 downto 0) = X"75" and Arrow_Key_found = '1' else -- Inc vol
--				   "11101" when shiftreg(7 downto 0) = X"72" and Arrow_Key_found = '1' else -- Dec vol
--				   "11110" when shiftreg(7 downto 0) = X"6B" and Arrow_Key_found = '1' else -- Bal left
--				   "11111" when shiftreg(7 downto 0) = X"74" and Arrow_Key_found = '1' else -- Bal right
--				   "00000";
--				         
--	Key_Code_Old <= shiftreg(7 downto 0);	